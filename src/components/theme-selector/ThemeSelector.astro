---
import { Icon } from "astro-icon/components";
---

<div class="theme-controls">
  <!-- Screen reader announcement for theme changes -->
  <div class="sr-only" role="status" aria-live="polite" id="themeAnnouncement">
  </div>

  <!-- Desktop: Always visible color picker -->
  <div
    class="theme-picker-desktop"
    role="group"
    aria-label="Color theme selector"
  >
    <button
      class="theme-button"
      data-theme="blue"
      aria-label="Select blue theme"
      aria-pressed="false"
      title="Blue"
    >
      <span class="color-swatch" style="background: #007db3;" aria-hidden="true"
      ></span>
    </button>
    <button
      class="theme-button"
      data-theme="pink"
      aria-label="Select pink theme"
      aria-pressed="false"
      title="Pink"
    >
      <span class="color-swatch" style="background: #DB2777;" aria-hidden="true"
      ></span>
    </button>
    <button
      class="theme-button"
      data-theme="green"
      aria-label="Select green theme"
      aria-pressed="false"
      title="Green"
    >
      <span class="color-swatch" style="background: #4C763B;" aria-hidden="true"
      ></span>
    </button>
    <button
      class="theme-button"
      data-theme="brown"
      aria-label="Select brown theme"
      aria-pressed="false"
      title="Brown"
    >
      <span class="color-swatch" style="background: #bf5700;" aria-hidden="true"
      ></span>
    </button>
    <button
      class="theme-button"
      data-theme="mono"
      aria-label="Select monochrome theme"
      aria-pressed="false"
      title="Monochrome"
    >
      <span class="color-swatch" style="background: #404040;" aria-hidden="true"
      ></span>
    </button>
    <button
      class="theme-button"
      data-theme="retro"
      aria-label="Select retro theme"
      aria-pressed="false"
      title="Retro"
    >
      <span
        class="color-swatch"
        style="background: linear-gradient(90deg, #134682 33%, #FEB216 33% 66%, #b31500 66%);"
        aria-hidden="true"></span>
    </button>
  </div>

  <!-- Mobile: Dropdown color picker -->
  <div class="theme-dropdown">
    <button
      class="theme-dropdown-button"
      id="themeDropdownButton"
      aria-label="Open color theme menu"
      aria-expanded="false"
    >
      <Icon name="swatch" size={24} aria-hidden="true" />
    </button>

    <div
      class="theme-picker-mobile"
      id="themePicker"
      role="menu"
      aria-label="Color theme selector"
    >
      <button
        class="theme-button"
        data-theme="blue"
        aria-label="Select blue theme"
        aria-pressed="false"
        title="Blue"
        role="menuitem"
      >
        <span
          class="color-swatch"
          style="background: #007db3;"
          aria-hidden="true"></span>
      </button>
      <button
        class="theme-button"
        data-theme="pink"
        aria-label="Select pink theme"
        aria-pressed="false"
        title="Pink"
        role="menuitem"
      >
        <span
          class="color-swatch"
          style="background: #DB2777;"
          aria-hidden="true"></span>
      </button>
      <button
        class="theme-button"
        data-theme="green"
        aria-label="Select green theme"
        aria-pressed="false"
        title="Green"
        role="menuitem"
      >
        <span
          class="color-swatch"
          style="background: #4C763B;"
          aria-hidden="true"></span>
      </button>
      <button
        class="theme-button"
        data-theme="brown"
        aria-label="Select brown theme"
        aria-pressed="false"
        title="Brown"
        role="menuitem"
      >
        <span
          class="color-swatch"
          style="background: #bf5700;"
          aria-hidden="true"></span>
      </button>
      <button
        class="theme-button"
        data-theme="mono"
        aria-label="Select monochrome theme"
        aria-pressed="false"
        title="Monochrome"
        role="menuitem"
      >
        <span
          class="color-swatch"
          style="background: #404040;"
          aria-hidden="true"></span>
      </button>
      <button
        class="theme-button"
        data-theme="retro"
        aria-label="Select retro theme"
        aria-pressed="false"
        title="Retro"
        role="menuitem"
      >
        <span
          class="color-swatch"
          style="background: linear-gradient(90deg, #134682 33%, #FEB216 33% 66%, #b31500 66%);"
          aria-hidden="true"></span>
      </button>
    </div>
  </div>

  <button
    id="darkModeToggle"
    aria-label="Toggle light and dark mode"
    aria-pressed="false"
  >
    <svg
      width="24px"
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path
        class="sun"
        fill-rule="evenodd"
        d="M12 17.5a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11zm0 1.5a7 7 0 1 0 0-14 7 7 0 0 0 0 14zm12-7a.8.8 0 0 1-.8.8h-2.4a.8.8 0 0 1 0-1.6h2.4a.8.8 0 0 1 .8.8zM4 12a.8.8 0 0 1-.8.8H.8a.8.8 0 0 1 0-1.6h2.5a.8.8 0 0 1 .8.8zm16.5-8.5a.8.8 0 0 1 0 1l-1.8 1.8a.8.8 0 0 1-1-1l1.7-1.8a.8.8 0 0 1 1 0zM6.3 17.7a.8.8 0 0 1 0 1l-1.7 1.8a.8.8 0 1 1-1-1l1.7-1.8a.8.8 0 0 1 1 0zM12 0a.8.8 0 0 1 .8.8v2.5a.8.8 0 0 1-1.6 0V.8A.8.8 0 0 1 12 0zm0 20a.8.8 0 0 1 .8.8v2.4a.8.8 0 0 1-1.6 0v-2.4a.8.8 0 0 1 .8-.8zM3.5 3.5a.8.8 0 0 1 1 0l1.8 1.8a.8.8 0 1 1-1 1L3.5 4.6a.8.8 0 0 1 0-1zm14.2 14.2a.8.8 0 0 1 1 0l1.8 1.7a.8.8 0 0 1-1 1l-1.8-1.7a.8.8 0 0 1 0-1z"
      ></path>
      <path
        class="moon"
        fill-rule="evenodd"
        d="M16.5 6A10.5 10.5 0 0 1 4.7 16.4 8.5 8.5 0 1 0 16.4 4.7l.1 1.3zm-1.7-2a9 9 0 0 1 .2 2 9 9 0 0 1-11 8.8 9.4 9.4 0 0 1-.8-.3c-.4 0-.8.3-.7.7a10 10 0 0 0 .3.8 10 10 0 0 0 9.2 6 10 10 0 0 0 4-19.2 9.7 9.7 0 0 0-.9-.3c-.3-.1-.7.3-.6.7a9 9 0 0 1 .3.8z"
      ></path>
    </svg>
  </button>
</div>

<script is:inline>
  // Initialize theme
  const initTheme = (() => {
    const savedTheme = localStorage?.getItem("colorTheme") || "blue";
    const savedMode = localStorage?.getItem("theme") || "";

    let mode = savedMode;
    if (!["dark", "light"].includes(mode)) {
      mode = window.matchMedia("(prefers-color-scheme: dark)").matches
        ? "dark"
        : "light";
    }

    // Apply theme
    document.documentElement.setAttribute("data-theme", savedTheme);
    if (mode === "dark") {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }

    localStorage.setItem("colorTheme", savedTheme);
    localStorage.setItem("theme", mode);

    return { theme: savedTheme, mode };
  })();

  // Announce to screen readers
  const announceTheme = (message) => {
    const announcement = document.getElementById("themeAnnouncement");
    if (announcement) {
      announcement.textContent = message;
      // Clear after announcement
      setTimeout(() => {
        announcement.textContent = "";
      }, 1000);
    }
  };

  // Toggle light/dark mode
  const handleToggleClick = () => {
    const element = document.documentElement;
    const toggleButton = document.getElementById("darkModeToggle");

    element.classList.toggle("dark");
    const isDark = element.classList.contains("dark");

    localStorage.setItem("theme", isDark ? "dark" : "light");

    // Update aria-pressed state
    if (toggleButton) {
      toggleButton.setAttribute("aria-pressed", isDark ? "true" : "false");
    }

    // Announce change
    announceTheme(`${isDark ? "Dark" : "Light"} mode activated`);
  };

  // Change color theme
  const handleThemeChange = (theme) => {
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem("colorTheme", theme);

    // Update active state and aria-pressed for both desktop and mobile buttons
    document.querySelectorAll(".theme-button").forEach((btn) => {
      const isActive = btn.dataset.theme === theme;
      btn.classList.toggle("active", isActive);
      btn.setAttribute("aria-pressed", isActive ? "true" : "false");
    });

    // Close dropdown after selection on mobile
    const dropdownButton = document.getElementById("themeDropdownButton");
    const themePicker = document.getElementById("themePicker");
    if (dropdownButton && themePicker) {
      themePicker.classList.remove("show");
      dropdownButton.setAttribute("aria-expanded", "false");
    }

    // Announce change
    const themeName = theme.charAt(0).toUpperCase() + theme.slice(1);
    announceTheme(`${themeName} theme selected`);
  };

  // Event listeners
  const darkModeToggle = document.getElementById("darkModeToggle");
  if (darkModeToggle) {
    darkModeToggle.addEventListener("click", handleToggleClick);
    // Set initial aria-pressed state
    const isDark = document.documentElement.classList.contains("dark");
    darkModeToggle.setAttribute("aria-pressed", isDark ? "true" : "false");
  }

  // Add listeners to all theme buttons (both desktop and mobile)
  document.querySelectorAll(".theme-button").forEach((button) => {
    button.addEventListener("click", () => {
      handleThemeChange(button.dataset.theme);
    });

    // Set initial active state and aria-pressed
    const isActive = button.dataset.theme === initTheme.theme;
    if (isActive) {
      button.classList.add("active");
      button.setAttribute("aria-pressed", "true");
    }
  });

  // Mobile dropdown functionality
  const dropdownButton = document.getElementById("themeDropdownButton");
  const themePicker = document.getElementById("themePicker");

  if (dropdownButton && themePicker) {
    // Toggle dropdown
    dropdownButton.addEventListener("click", (e) => {
      e.stopPropagation();
      const isOpen = themePicker.classList.contains("show");

      if (isOpen) {
        themePicker.classList.remove("show");
        dropdownButton.setAttribute("aria-expanded", "false");
      } else {
        themePicker.classList.add("show");
        dropdownButton.setAttribute("aria-expanded", "true");
      }
    });

    // Close when clicking outside
    document.addEventListener("click", (event) => {
      if (themePicker.classList.contains("show")) {
        if (
          !themePicker.contains(event.target) &&
          event.target !== dropdownButton
        ) {
          themePicker.classList.remove("show");
          dropdownButton.setAttribute("aria-expanded", "false");
        }
      }
    });

    // Handle Escape key
    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && themePicker.classList.contains("show")) {
        themePicker.classList.remove("show");
        dropdownButton.setAttribute("aria-expanded", "false");
        dropdownButton.focus();
      }
    });
  }

  // System preference listener
  window
    .matchMedia("(prefers-color-scheme: dark)")
    .addEventListener("change", (e) => {
      const newTheme = e.matches ? "dark" : "light";
      if (localStorage.getItem("theme") !== newTheme) {
        document.documentElement.classList.toggle("dark", e.matches);
        localStorage.setItem("theme", newTheme);

        // Update toggle button state
        const toggleButton = document.getElementById("darkModeToggle");
        if (toggleButton) {
          toggleButton.setAttribute(
            "aria-pressed",
            e.matches ? "true" : "false"
          );
        }
      }
    });
</script>

<script>
  // Floating UI positioning (only on mobile)
  import {
    computePosition,
    flip,
    shift,
    offset,
    autoUpdate,
  } from "@floating-ui/dom";

  let cleanup: (() => void) | null = null;

  const updatePosition = () => {
    const dropdownButton = document.getElementById("themeDropdownButton");
    const themePicker = document.getElementById("themePicker");

    if (
      !dropdownButton ||
      !themePicker ||
      !themePicker.classList.contains("show")
    )
      return;

    computePosition(dropdownButton, themePicker, {
      placement: "bottom",
      strategy: "absolute",
      middleware: [
        offset(12),
        flip({
          fallbackPlacements: ["top", "bottom-start", "bottom-end"],
          padding: 8,
        }),
        shift({
          padding: 8,
        }),
      ],
    }).then(({ x, y }) => {
      Object.assign(themePicker.style, {
        left: `${x}px`,
        top: `${y}px`,
      });
    });
  };

  // Set up positioning when dropdown opens
  const observeDropdown = () => {
    const dropdownButton = document.getElementById("themeDropdownButton");
    const themePicker = document.getElementById("themePicker");

    if (!dropdownButton || !themePicker) return;

    // Watch for class changes on themePicker
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === "class") {
          const isOpen = themePicker.classList.contains("show");

          if (isOpen && window.innerWidth < 1000) {
            // Start positioning
            if (cleanup) cleanup();
            cleanup = autoUpdate(dropdownButton, themePicker, updatePosition);
          } else if (cleanup) {
            // Stop positioning
            cleanup();
            cleanup = null;
          }
        }
      });
    });

    observer.observe(themePicker, { attributes: true });
  };

  // Initialize
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", observeDropdown);
  } else {
    observeDropdown();
  }
</script>

<style>
  .color-swatch {
    border-radius: 25px;
    display: block;
    height: 24px;
    width: 24px;
  }

  #darkModeToggle {
    background: none;
    border: 0;
    border-radius: 50%;
    cursor: pointer;
    padding: 0.5rem;
    transition: background-color 0s;
  }

  #darkModeToggle:active {
    opacity: 0.75;
  }

  #darkModeToggle:focus-visible {
    outline: 2px dashed rgba(var(--secondary-color), 1);
    outline-offset: 2px;
  }

  #darkModeToggle:hover {
    background-color: rgba(var(--ambience-color), 1);
  }

  .moon {
    fill: transparent;
  }

  .sun {
    fill: rgba(var(--primary-color), 1);
  }

  .sr-only {
    border-width: 0;
    clip: rect(0, 0, 0, 0);
    height: 1px;
    margin: -1px;
    overflow: hidden;
    padding: 0;
    position: absolute;
    white-space: nowrap;
    width: 1px;
  }

  .theme-button {
    background: none;
    border: 2px solid transparent;
    border-radius: 25px;
    cursor: pointer;
    padding: 0.25rem;
    transition: border-color 0s;
  }

  .theme-button.active,
  .theme-button[aria-pressed="true"] {
    border-color: rgba(var(--primary-color), 1);
  }

  .theme-button:focus-visible {
    outline: 2px dashed rgba(var(--secondary-color), 1);
    outline-offset: 2px;
  }

  .theme-button:hover {
    border-color: rgba(var(--primary-color), 0.5);
  }

  .theme-controls {
    align-items: center;
    display: flex;
    gap: 0.5rem;
  }

  .theme-dropdown {
    display: block;
    position: relative;
  }

  .theme-dropdown-button {
    align-items: center;
    background: none;
    border: 0;
    border-radius: 50%;
    color: rgba(var(--primary-color), 1);
    cursor: pointer;
    display: flex;
    justify-content: center;
    list-style: none;
    padding: 0.5rem;
  }

  .theme-dropdown-button:focus-visible {
    outline: 2px dashed rgba(var(--secondary-color), 1);
    outline-offset: 2px;
  }

  .theme-dropdown-button:hover {
    background-color: rgba(var(--ambience-color), 1);
  }

  .theme-picker-desktop {
    background-color: rgba(var(--floating-color), 0.7);
    border-radius: 25px;
    display: none;
    gap: 0.5rem;
    padding-block: 0.5rem;
    padding-inline: 0.5rem;
  }

  .theme-picker-mobile {
    background-color: rgba(var(--floating-color), 0.8);
    backdrop-filter: blur(10px);
    border-radius: 25px;
    box-shadow: 0 4px 16px rgba(var(--shadow-color));
    display: none;
    gap: 0.5rem;
    inset-block-start: 0;
    inset-inline-start: 0;
    padding-block: 0.5rem;
    padding-inline: 0.5rem;
    position: absolute;
    z-index: 1000;
  }

  .theme-picker-mobile.show {
    display: flex;
  }

  :global(.dark) .moon {
    fill: rgba(var(--primary-color), 1);
  }

  :global(.dark) .sun {
    fill: transparent;
  }

  @media (min-width: 1000px) {
    .theme-dropdown {
      display: none;
    }

    .theme-picker-desktop {
      display: flex;
    }
  }
</style>
